{% extends 'interview_core/base.html' %}

{% block title %}Microphone Test{% endblock %}

{% block content %}
<section class="form-section">
    <div class="container-small">
        <div class="form-card">
            <div class="form-header">
                <h2 class="form-title">Microphone Test</h2>
                <p class="form-subtitle">Test your microphone before starting the interview</p>
            </div>
            
            <div id="test-status" class="info-box" style="margin-bottom: 1.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 16v-4"></path>
                    <path d="M12 8h.01"></path>
                </svg>
                <span id="status-text">Click "Test Microphone" to begin</span>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Troubleshooting Steps:</h3>
                <ol style="font-size: 0.9rem; color: #6B7280; line-height: 1.8; padding-left: 1.5rem;">
                    <li>Click the ðŸ”’ lock icon in your browser's address bar</li>
                    <li>Find "Microphone" and change to "Allow"</li>
                    <li>Refresh this page (F5)</li>
                    <li>Click "Test Microphone" button below</li>
                </ol>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Windows Settings:</h3>
                <ol style="font-size: 0.9rem; color: #6B7280; line-height: 1.8; padding-left: 1.5rem;">
                    <li>Press Win + I to open Settings</li>
                    <li>Go to Privacy & Security â†’ Microphone</li>
                    <li>Turn ON "Microphone access"</li>
                    <li>Turn ON "Let apps access your microphone"</li>
                    <li>Make sure your browser has permission</li>
                </ol>
            </div>

            <button id="test-btn" class="btn-primary" style="margin-bottom: 1rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
                <span>Test Microphone</span>
            </button>

            <div id="audio-level" style="display: none; margin-bottom: 1.5rem;">
                <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem;">Audio Level:</label>
                <div style="width: 100%; height: 30px; background: #F3F4F6; border-radius: 8px; overflow: hidden;">
                    <div id="level-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #10B981, #3B5FCC); transition: width 0.1s;"></div>
                </div>
            </div>

            <div id="success-message" style="display: none;">
                <div style="padding: 1rem; background: #D1FAE5; border: 1px solid #10B981; border-radius: 8px; color: #065F46; margin-bottom: 1rem;">
                    <strong>âœ“ Success!</strong> Your microphone is working correctly.
                </div>
                <a href="{% url 'interview_start' %}" class="btn-primary">
                    <span>Continue to Interview</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                        <polyline points="12 5 19 12 12 19"></polyline>
                    </svg>
                </a>
            </div>
        </div>
    </div>
</section>

<script>
    const testBtn = document.getElementById('test-btn');
    const statusText = document.getElementById('status-text');
    const testStatus = document.getElementById('test-status');
    const audioLevel = document.getElementById('audio-level');
    const levelBar = document.getElementById('level-bar');
    const successMessage = document.getElementById('success-message');

    let audioContext;
    let analyser;
    let microphone;
    let javascriptNode;

    testBtn.addEventListener('click', async () => {
        try {
            statusText.textContent = 'Requesting microphone access...';
            testStatus.style.background = '#FEF3C7';
            testStatus.style.borderColor = '#FCD34D';
            testStatus.style.color = '#92400E';

            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            statusText.textContent = 'âœ“ Microphone access granted! Speak to see audio levels.';
            testStatus.style.background = '#D1FAE5';
            testStatus.style.borderColor = '#10B981';
            testStatus.style.color = '#065F46';
            
            audioLevel.style.display = 'block';
            testBtn.disabled = true;
            testBtn.style.opacity = '0.5';

            // Set up audio analysis
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

            analyser.smoothingTimeConstant = 0.8;
            analyser.fftSize = 1024;

            microphone.connect(analyser);
            analyser.connect(javascriptNode);
            javascriptNode.connect(audioContext.destination);

            javascriptNode.onaudioprocess = function() {
                const array = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(array);
                const values = array.reduce((a, b) => a + b, 0);
                const average = values / array.length;
                const percentage = Math.min(100, (average / 128) * 100);
                levelBar.style.width = percentage + '%';
            };

            // Show success after 3 seconds of working microphone
            setTimeout(() => {
                successMessage.style.display = 'block';
            }, 3000);

        } catch (error) {
            console.error('Microphone error:', error);
            
            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                statusText.textContent = 'âœ— Microphone access denied. Please check browser permissions.';
                testStatus.style.background = '#FEE2E2';
                testStatus.style.borderColor = '#EF4444';
                testStatus.style.color = '#991B1B';
            } else if (error.name === 'NotFoundError') {
                statusText.textContent = 'âœ— No microphone found. Please connect a microphone.';
                testStatus.style.background = '#FEE2E2';
                testStatus.style.borderColor = '#EF4444';
                testStatus.style.color = '#991B1B';
            } else {
                statusText.textContent = 'âœ— Error: ' + error.message;
                testStatus.style.background = '#FEE2E2';
                testStatus.style.borderColor = '#EF4444';
                testStatus.style.color = '#991B1B';
            }
        }
    });
</script>
{% endblock %}
